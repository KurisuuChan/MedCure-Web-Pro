<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üö® CRITICAL: Deploy Stock Logic Fix</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        min-height: 100vh;
        color: white;
      }
      .container {
        background: white;
        color: #1f2937;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      .critical {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }
      .step {
        background: #fef2f2;
        border-left: 5px solid #dc2626;
        padding: 20px;
        margin: 20px 0;
        border-radius: 0 10px 10px 0;
      }
      .sql-code {
        background: #1f2937;
        color: #e5e7eb;
        padding: 20px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        overflow-x: auto;
        margin: 15px 0;
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #dc2626;
      }
      .copy-btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin: 10px 0;
        font-weight: bold;
        font-size: 16px;
      }
      .copy-btn:hover {
        background: #b91c1c;
      }
      .success {
        background: #dcfce7;
        border: 1px solid #bbf7d0;
        color: #166534;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .warning {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        color: #92400e;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="critical">
        <h1>üö® CRITICAL STOCK LOGIC FIX DEPLOYMENT</h1>
        <p>
          <strong>Issue:</strong> Stock being deducted multiple times during
          transaction editing
        </p>
        <p>
          <strong>Impact:</strong> Medicines gradually disappearing from
          inventory
        </p>
        <p><strong>Priority:</strong> IMMEDIATE DEPLOYMENT REQUIRED</p>
      </div>

      <div class="warning">
        <h3>‚ö†Ô∏è Before Deployment</h3>
        <p>
          <strong>Backup recommended:</strong> Export current product stock
          levels for verification
        </p>
        <p>
          <strong>Timing:</strong> Deploy during low-activity period if possible
        </p>
        <p><strong>Testing:</strong> Test with 1-2 products after deployment</p>
      </div>

      <div class="step">
        <h2>üìã Step 1: Access Supabase Dashboard</h2>
        <ol>
          <li>
            Go to
            <a
              href="https://supabase.com/dashboard"
              target="_blank"
              rel="noopener"
              >https://supabase.com/dashboard</a
            >
          </li>
          <li>Select your project: <strong>MedCure Pharmacy</strong></li>
          <li>Click <strong>"SQL Editor"</strong> in the left sidebar</li>
          <li>Click <strong>"New Query"</strong></li>
        </ol>
      </div>

      <div class="step">
        <h2>üíæ Step 2: Deploy Stock Logic Fix</h2>
        <p>
          <strong>Copy the COMPLETE SQL script below and execute it:</strong>
        </p>

        <button class="copy-btn" onclick="copySQLScript()">
          üìã Copy Complete Fix Script
        </button>

        <div class="sql-code" id="fixScript">
          -- ================================================= -- üö® CRITICAL
          FIX: STOCK MANAGEMENT LOGIC ERROR -- This fixes the double deduction
          and inconsistent stock handling --
          ================================================= --
          ================================================= -- 1. FIRST: CREATE
          PROPER STOCK DEDUCTION TRIGGER --
          ================================================= CREATE OR REPLACE
          FUNCTION deduct_stock_on_sale() RETURNS TRIGGER AS $$ DECLARE
          current_stock INTEGER; pieces_to_deduct INTEGER;
          product_pieces_per_sheet INTEGER; product_sheets_per_box INTEGER;
          product_name TEXT; BEGIN -- Get current stock and product
          configuration SELECT stock_in_pieces, pieces_per_sheet,
          sheets_per_box, name INTO current_stock, product_pieces_per_sheet,
          product_sheets_per_box, product_name FROM products WHERE id =
          NEW.product_id; -- Calculate pieces to deduct based on unit type CASE
          COALESCE(NEW.unit_type, 'piece') WHEN 'piece' THEN pieces_to_deduct :=
          NEW.quantity; WHEN 'sheet' THEN pieces_to_deduct := NEW.quantity *
          COALESCE(product_pieces_per_sheet, 1); WHEN 'box' THEN
          pieces_to_deduct := NEW.quantity * COALESCE(product_pieces_per_sheet,
          1) * COALESCE(product_sheets_per_box, 1); ELSE pieces_to_deduct :=
          NEW.quantity; END CASE; -- Check stock availability IF current_stock <
          pieces_to_deduct THEN RAISE EXCEPTION 'Insufficient stock for product
          %: needed %, available %', product_name, pieces_to_deduct,
          current_stock; END IF; -- Update product stock UPDATE products SET
          stock_in_pieces = current_stock - pieces_to_deduct WHERE id =
          NEW.product_id; -- Log the stock movement INSERT INTO stock_movements
          ( product_id, user_id, movement_type, quantity, reason,
          reference_type, reference_id, stock_before, stock_after ) VALUES (
          NEW.product_id, (SELECT user_id FROM sales WHERE id = NEW.sale_id),
          'out', pieces_to_deduct, 'Stock deducted for sale', 'sale',
          NEW.sale_id, current_stock, current_stock - pieces_to_deduct ); RETURN
          NEW; END; $$ LANGUAGE plpgsql; -- Create trigger for automatic stock
          deduction on sale_items INSERT DROP TRIGGER IF EXISTS
          trigger_deduct_stock_on_sale ON sale_items; CREATE TRIGGER
          trigger_deduct_stock_on_sale AFTER INSERT ON sale_items FOR EACH ROW
          EXECUTE FUNCTION deduct_stock_on_sale(); --
          ================================================= -- 2. FIX STOCK
          RESTORATION TRIGGER (Already exists but ensure it's correct) --
          ================================================= CREATE OR REPLACE
          FUNCTION restore_stock_on_edit() RETURNS TRIGGER AS $$ DECLARE
          current_stock INTEGER; pieces_to_restore INTEGER;
          product_pieces_per_sheet INTEGER; product_sheets_per_box INTEGER;
          BEGIN -- Get current stock and product configuration SELECT
          stock_in_pieces, pieces_per_sheet, sheets_per_box INTO current_stock,
          product_pieces_per_sheet, product_sheets_per_box FROM products WHERE
          id = OLD.product_id; -- Calculate pieces to restore based on unit type
          CASE COALESCE(OLD.unit_type, 'piece') WHEN 'piece' THEN
          pieces_to_restore := OLD.quantity; WHEN 'sheet' THEN pieces_to_restore
          := OLD.quantity * COALESCE(product_pieces_per_sheet, 1); WHEN 'box'
          THEN pieces_to_restore := OLD.quantity *
          COALESCE(product_pieces_per_sheet, 1) *
          COALESCE(product_sheets_per_box, 1); ELSE pieces_to_restore :=
          OLD.quantity; END CASE; -- Update product stock UPDATE products SET
          stock_in_pieces = current_stock + pieces_to_restore WHERE id =
          OLD.product_id; -- Log the stock movement INSERT INTO stock_movements
          ( product_id, user_id, movement_type, quantity, reason,
          reference_type, reference_id, stock_before, stock_after ) VALUES (
          OLD.product_id, (SELECT user_id FROM sales WHERE id = OLD.sale_id),
          'in', pieces_to_restore, 'Stock restored during transaction edit',
          'sale_edit', OLD.sale_id, current_stock, current_stock +
          pieces_to_restore ); RETURN OLD; END; $$ LANGUAGE plpgsql; -- Ensure
          the restoration trigger exists DROP TRIGGER IF EXISTS
          trigger_restore_stock_on_sale_item_delete ON sale_items; CREATE
          TRIGGER trigger_restore_stock_on_sale_item_delete BEFORE DELETE ON
          sale_items FOR EACH ROW EXECUTE FUNCTION restore_stock_on_edit(); --
          ================================================= -- 3. FIX
          TRANSACTION EDITING FUNCTION (Remove manual stock handling) --
          ================================================= CREATE OR REPLACE
          FUNCTION edit_transaction_with_stock_management( p_transaction_id
          UUID, p_new_items JSONB, p_edit_data JSONB ) RETURNS TABLE( success
          BOOLEAN, message TEXT, transaction_id UUID ) AS $$ DECLARE item JSONB;
          items_count INTEGER; BEGIN -- Start transaction BEGIN -- 1. Update the
          sales record UPDATE sales SET total_amount =
          (p_edit_data->>'total_amount')::DECIMAL, subtotal_before_discount =
          (p_edit_data->>'subtotal_before_discount')::DECIMAL, discount_type =
          COALESCE(p_edit_data->>'discount_type', 'none'), discount_percentage =
          COALESCE((p_edit_data->>'discount_percentage')::DECIMAL, 0),
          discount_amount = COALESCE((p_edit_data->>'discount_amount')::DECIMAL,
          0), pwd_senior_id = CASE WHEN p_edit_data->>'pwd_senior_id' = 'null'
          OR p_edit_data->>'pwd_senior_id' = '' THEN NULL ELSE
          (p_edit_data->>'pwd_senior_id')::UUID END, is_edited = true, edited_at
          = NOW(), edited_by = (p_edit_data->>'edited_by')::UUID, edit_reason =
          p_edit_data->>'edit_reason' WHERE id = p_transaction_id; -- 2. Delete
          old sale items (this will trigger stock restoration automatically)
          DELETE FROM sale_items WHERE sale_id = p_transaction_id; -- 3. Check
          if we have items to process items_count :=
          jsonb_array_length(p_new_items); -- Only process items if array is not
          empty IF items_count > 0 THEN -- 4. Insert new items (triggers will
          handle stock deduction automatically) FOR item IN SELECT * FROM
          jsonb_array_elements(p_new_items) LOOP -- Insert new sale item
          (trigger will handle stock deduction) INSERT INTO sale_items (
          sale_id, product_id, quantity, unit_type, unit_price, total_price )
          VALUES ( p_transaction_id, (item->>'product_id')::UUID,
          (item->>'quantity')::INTEGER, COALESCE(item->>'unit_type', 'piece'),
          (item->>'unit_price')::DECIMAL, (item->>'total_price')::DECIMAL ); --
          Note: Stock deduction is handled automatically by trigger -- No manual
          stock manipulation needed! END LOOP; ELSE RAISE NOTICE 'No items to
          process in transaction edit'; END IF; -- Return success RETURN QUERY
          SELECT true, 'Transaction edited successfully'::TEXT,
          p_transaction_id; EXCEPTION WHEN OTHERS THEN -- Log the error details
          RAISE NOTICE 'Error in edit_transaction_with_stock_management: %',
          SQLERRM; -- Rollback and return error RAISE; END; END; $$ LANGUAGE
          plpgsql; -- ================================================= -- ‚úÖ
          STOCK LOGIC FIX COMPLETE! --
          ================================================= SELECT 'Stock
          management logic fixed - now using consistent trigger-based approach!'
          as status;
        </div>
      </div>

      <div class="step">
        <h2>‚ñ∂Ô∏è Step 3: Execute the Script</h2>
        <ol>
          <li>Paste the copied SQL script into the SQL Editor</li>
          <li>Click the <strong>"Run"</strong> button (or press Ctrl+Enter)</li>
          <li>Wait for the script to complete</li>
          <li>
            You should see:
            <code
              >"Stock management logic fixed - now using consistent
              trigger-based approach!"</code
            >
          </li>
        </ol>
      </div>

      <div class="step">
        <h2>üß™ Step 4: Test the Fix</h2>
        <p><strong>Critical Testing Protocol:</strong></p>

        <ol>
          <li>
            <strong>Record Stock Before:</strong> Note stock levels of 2-3
            products
          </li>
          <li>
            <strong>Test Normal Sale:</strong>
            <ul>
              <li>Create a sale with those products</li>
              <li>Verify stock decreases correctly</li>
              <li>Complete the transaction</li>
            </ul>
          </li>
          <li>
            <strong>Test Transaction Edit:</strong>
            <ul>
              <li>Edit the transaction (change quantities)</li>
              <li>Save the changes</li>
              <li>Verify stock adjusts correctly (no double deduction!)</li>
            </ul>
          </li>
          <li>
            <strong>Verify Audit Trail:</strong>
            <ul>
              <li>Check stock_movements table</li>
              <li>Should see proper 'out' and 'in' movements</li>
            </ul>
          </li>
        </ol>
      </div>

      <div class="success">
        <h3>‚úÖ Expected Results After Fix</h3>
        <ul>
          <li>‚úÖ <strong>New Sales:</strong> Stock deducted once correctly</li>
          <li>
            ‚úÖ <strong>Transaction Edits:</strong> Stock restored and
            re-deducted accurately
          </li>
          <li>
            ‚úÖ <strong>No Double Deduction:</strong> Stock levels remain
            accurate
          </li>
          <li>
            ‚úÖ <strong>Audit Trail:</strong> All movements logged properly
          </li>
          <li>
            ‚úÖ <strong>Consistency:</strong> Same logic for all operations
          </li>
        </ul>
      </div>

      <div class="step">
        <h2>üîç Step 5: Verification Queries</h2>
        <p>Run these queries after deployment to verify the fix:</p>

        <div class="sql-code">
          -- Check if triggers are active SELECT trigger_name,
          event_manipulation, trigger_schema, table_name FROM
          information_schema.triggers WHERE table_name = 'sale_items' ORDER BY
          trigger_name; -- Check recent stock movements SELECT sm.*, p.name as
          product_name FROM stock_movements sm JOIN products p ON sm.product_id
          = p.id ORDER BY sm.created_at DESC LIMIT 10;
        </div>
      </div>
    </div>

    <script>
      function copySQLScript() {
        const sqlScript = document.getElementById("fixScript").textContent;
        navigator.clipboard
          .writeText(sqlScript)
          .then(() => {
            alert(
              "‚úÖ Critical fix script copied to clipboard!\n\nPaste it into Supabase SQL Editor and click Run."
            );
          })
          .catch((err) => {
            console.error("Failed to copy: ", err);
            alert(
              "‚ùå Failed to copy. Please manually select and copy the SQL script."
            );
          });
      }
    </script>
  </body>
</html>
