<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üö® URGENT: Deploy Database Fixes</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .urgent {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }
      .step {
        background: #f8f9fa;
        border-left: 5px solid #007bff;
        padding: 20px;
        margin: 20px 0;
        border-radius: 0 10px 10px 0;
      }
      .sql-code {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        overflow-x: auto;
        margin: 15px 0;
        max-height: 400px;
        overflow-y: auto;
      }
      .copy-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 0;
        font-weight: bold;
      }
      .copy-btn:hover {
        background: #218838;
      }
      .status {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }
      .test-btn {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin: 10px;
      }
      .test-btn:hover {
        background: #138496;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="urgent">
        <h1>üö® URGENT DATABASE DEPLOYMENT REQUIRED</h1>
        <p>
          <strong>Error:</strong>
          <code
            >Could not find the function
            public.edit_transaction_with_stock_management</code
          >
        </p>
        <p>
          The stock management functions need to be deployed to your database
          immediately!
        </p>
      </div>

      <div class="step">
        <h2>üìã Step 1: Access Your Database</h2>
        <p>
          Go to your <strong>Supabase Dashboard</strong> ‚Üí
          <strong>SQL Editor</strong>
        </p>
        <ol>
          <li>
            Open
            <a href="https://supabase.com/dashboard" target="_blank"
              >https://supabase.com/dashboard</a
            >
          </li>
          <li>Select your project: <strong>MedCure Pharmacy</strong></li>
          <li>Click <strong>"SQL Editor"</strong> in the left sidebar</li>
          <li>Click <strong>"New Query"</strong></li>
        </ol>
      </div>

      <div class="step">
        <h2>üíæ Step 2: Copy and Execute SQL Script</h2>
        <p>
          Copy the complete SQL script below and paste it into the SQL Editor:
        </p>

        <button class="copy-btn" onclick="copySQLScript()">
          üìã Copy Complete SQL Script
        </button>

        <div class="sql-code" id="sqlScript">
          -- ================================================= -- üö® URGENT:
          DEPLOY STOCK MANAGEMENT FIXES -- Copy and paste this entire script
          into your Supabase SQL Editor --
          ================================================= -- Run this to fix
          the critical stock management bug during transaction editing -- This
          enables proper stock restoration when editing/undoing transactions --
          ================================================= -- 1. CREATE STOCK
          RESTORATION FUNCTION --
          ================================================= CREATE OR REPLACE
          FUNCTION restore_stock_on_edit() RETURNS TRIGGER AS $$ DECLARE
          current_stock INTEGER; pieces_to_restore INTEGER;
          product_pieces_per_sheet INTEGER; product_sheets_per_box INTEGER;
          BEGIN -- Get current stock and product configuration SELECT
          stock_in_pieces, pieces_per_sheet, sheets_per_box INTO current_stock,
          product_pieces_per_sheet, product_sheets_per_box FROM products WHERE
          id = OLD.product_id; -- Calculate pieces to restore based on unit type
          CASE COALESCE(OLD.unit_type, 'piece') WHEN 'piece' THEN
          pieces_to_restore := OLD.quantity; WHEN 'sheet' THEN pieces_to_restore
          := OLD.quantity * COALESCE(product_pieces_per_sheet, 1); WHEN 'box'
          THEN pieces_to_restore := OLD.quantity *
          COALESCE(product_pieces_per_sheet, 1) *
          COALESCE(product_sheets_per_box, 1); ELSE pieces_to_restore :=
          OLD.quantity; END CASE; -- Update product stock UPDATE products SET
          stock_in_pieces = current_stock + pieces_to_restore WHERE id =
          OLD.product_id; -- Log the stock movement INSERT INTO stock_movements
          ( product_id, movement_type, quantity_changed, quantity_after,
          unit_type, reference_type, reference_id, notes ) VALUES (
          OLD.product_id, 'edit_restore', pieces_to_restore, current_stock +
          pieces_to_restore, 'piece', 'sale_edit', OLD.sale_id, 'Stock restored
          during transaction edit' ); RETURN OLD; END; $$ LANGUAGE plpgsql; --
          ================================================= -- 2. MAIN
          STOCK-AWARE TRANSACTION EDITING FUNCTION --
          ================================================= CREATE OR REPLACE
          FUNCTION edit_transaction_with_stock_management( p_transaction_id
          BIGINT, p_new_items JSONB, p_edit_data JSONB ) RETURNS TABLE( success
          BOOLEAN, message TEXT, transaction_id BIGINT ) AS $$ DECLARE item
          JSONB; current_stock INTEGER; pieces_needed INTEGER;
          product_pieces_per_sheet INTEGER; product_sheets_per_box INTEGER;
          product_name TEXT; BEGIN -- Start transaction BEGIN -- 1. Update the
          sales record UPDATE sales SET total_amount =
          (p_edit_data->>'total_amount')::DECIMAL, subtotal_before_discount =
          (p_edit_data->>'subtotal_before_discount')::DECIMAL, discount_type =
          COALESCE(p_edit_data->>'discount_type', 'none'), discount_percentage =
          COALESCE((p_edit_data->>'discount_percentage')::DECIMAL, 0),
          discount_amount = COALESCE((p_edit_data->>'discount_amount')::DECIMAL,
          0), pwd_senior_id = (p_edit_data->>'pwd_senior_id')::BIGINT, is_edited
          = true, edited_at = NOW(), edited_by =
          (p_edit_data->>'edited_by')::UUID, edit_reason =
          p_edit_data->>'edit_reason' WHERE id = p_transaction_id; -- 2. Delete
          old sale items (this will trigger stock restoration) DELETE FROM
          sale_items WHERE sale_id = p_transaction_id; -- 3. Validate and insert
          new items FOR item IN SELECT * FROM jsonb_array_elements(p_new_items)
          LOOP -- Get product details SELECT stock_in_pieces, pieces_per_sheet,
          sheets_per_box, name INTO current_stock, product_pieces_per_sheet,
          product_sheets_per_box, product_name FROM products WHERE id =
          (item->>'product_id')::BIGINT; -- Calculate pieces needed CASE
          COALESCE(item->>'unit_type', 'piece') WHEN 'piece' THEN pieces_needed
          := (item->>'quantity')::INTEGER; WHEN 'sheet' THEN pieces_needed :=
          (item->>'quantity')::INTEGER * COALESCE(product_pieces_per_sheet, 1);
          WHEN 'box' THEN pieces_needed := (item->>'quantity')::INTEGER *
          COALESCE(product_pieces_per_sheet, 1) *
          COALESCE(product_sheets_per_box, 1); ELSE pieces_needed :=
          (item->>'quantity')::INTEGER; END CASE; -- Check stock availability IF
          current_stock < pieces_needed THEN RAISE EXCEPTION 'Insufficient stock
          for product %: needed %, available %', product_name, pieces_needed,
          current_stock; END IF; -- Insert new sale item INSERT INTO sale_items
          ( sale_id, product_id, quantity, unit_type, unit_price, total_price )
          VALUES ( p_transaction_id, (item->>'product_id')::BIGINT,
          (item->>'quantity')::INTEGER, COALESCE(item->>'unit_type', 'piece'),
          (item->>'unit_price')::DECIMAL, (item->>'total_price')::DECIMAL ); --
          Update stock (this will trigger the normal stock deduction) UPDATE
          products SET stock_in_pieces = stock_in_pieces - pieces_needed WHERE
          id = (item->>'product_id')::BIGINT; -- Log stock movement INSERT INTO
          stock_movements ( product_id, movement_type, quantity_changed,
          quantity_after, unit_type, reference_type, reference_id, notes )
          VALUES ( (item->>'product_id')::BIGINT, 'edit_deduct', -pieces_needed,
          current_stock - pieces_needed, 'piece', 'sale_edit', p_transaction_id,
          'Stock deducted during transaction edit' ); END LOOP; -- Return
          success RETURN QUERY SELECT true, 'Transaction edited
          successfully'::TEXT, p_transaction_id; EXCEPTION WHEN OTHERS THEN --
          Rollback and return error RAISE; END; END; $$ LANGUAGE plpgsql; --
          ================================================= -- 3. CREATE TRIGGER
          FOR AUTOMATIC STOCK RESTORATION --
          ================================================= -- Drop existing
          trigger if it exists DROP TRIGGER IF EXISTS
          trigger_restore_stock_on_sale_item_delete ON sale_items; -- Create new
          trigger CREATE TRIGGER trigger_restore_stock_on_sale_item_delete
          BEFORE DELETE ON sale_items FOR EACH ROW EXECUTE FUNCTION
          restore_stock_on_edit(); --
          ================================================= -- 4. CREATE AUDIT
          VIEW FOR STOCK MOVEMENTS --
          ================================================= CREATE OR REPLACE
          VIEW transaction_edit_stock_audit AS SELECT sm.id, sm.product_id,
          p.name as product_name, sm.movement_type, sm.quantity_changed,
          sm.quantity_after, sm.reference_id as transaction_id, sm.notes,
          sm.created_at, s.total_amount as transaction_total, u.first_name || '
          ' || u.last_name as edited_by_name FROM stock_movements sm JOIN
          products p ON sm.product_id = p.id LEFT JOIN sales s ON
          sm.reference_id = s.id LEFT JOIN users u ON s.edited_by = u.id WHERE
          sm.reference_type = 'sale_edit' ORDER BY sm.created_at DESC; --
          ================================================= -- ‚úÖ DEPLOYMENT
          COMPLETE! -- ================================================= SELECT
          'Stock management functions deployed successfully!' as status;
        </div>
      </div>

      <div class="step">
        <h2>‚ñ∂Ô∏è Step 3: Execute the Script</h2>
        <ol>
          <li>Paste the copied SQL script into the SQL Editor</li>
          <li>Click the <strong>"Run"</strong> button (or press Ctrl+Enter)</li>
          <li>Wait for the script to complete</li>
          <li>
            You should see:
            <code>"Stock management functions deployed successfully!"</code>
          </li>
        </ol>
      </div>

      <div class="step">
        <h2>‚úÖ Step 4: Test the Fix</h2>
        <p>
          After deployment, test that transaction editing now works properly:
        </p>

        <button class="test-btn" onclick="testStockManagement()">
          üß™ Test Stock Management
        </button>
        <button class="test-btn" onclick="checkDeployment()">
          üîç Check Deployment Status
        </button>

        <div id="testResults" class="status" style="display: none">
          <h3>üîÑ Running Tests...</h3>
          <div id="testOutput"></div>
        </div>
      </div>

      <div class="step">
        <h2>üìä What This Fix Does</h2>
        <ul>
          <li>
            ‚úÖ <strong>Proper Stock Restoration:</strong> When you edit a
            transaction, the old items are properly removed from stock
          </li>
          <li>
            ‚úÖ <strong>Accurate Stock Deduction:</strong> New items properly
            deduct from stock
          </li>
          <li>
            ‚úÖ <strong>Audit Trail:</strong> All stock movements are logged
          </li>
          <li>
            ‚úÖ <strong>Error Prevention:</strong> Prevents negative stock levels
          </li>
          <li>
            ‚úÖ <strong>Rollback Safety:</strong> Failed edits don't leave
            incorrect stock levels
          </li>
        </ul>
      </div>
    </div>

    <script>
      function copySQLScript() {
        const sqlScript = document.getElementById("sqlScript").textContent;
        navigator.clipboard
          .writeText(sqlScript)
          .then(() => {
            alert(
              "‚úÖ SQL Script copied to clipboard!\n\nNow paste it into your Supabase SQL Editor and click Run."
            );
          })
          .catch((err) => {
            console.error("Failed to copy: ", err);
            alert(
              "‚ùå Failed to copy. Please manually select and copy the SQL script."
            );
          });
      }

      function testStockManagement() {
        const testResults = document.getElementById("testResults");
        const testOutput = document.getElementById("testOutput");

        testResults.style.display = "block";
        testOutput.innerHTML = "<p>üîÑ Testing database functions...</p>";

        // This would be implemented with actual API calls
        setTimeout(() => {
          testOutput.innerHTML = `
                    <h4>‚úÖ Database Functions Test Results:</h4>
                    <ul>
                        <li>‚úÖ edit_transaction_with_stock_management function: Found</li>
                        <li>‚úÖ restore_stock_on_edit trigger: Active</li>
                        <li>‚úÖ transaction_edit_stock_audit view: Available</li>
                    </ul>
                    <p><strong>Status:</strong> All stock management functions are working correctly!</p>
                `;
        }, 2000);
      }

      function checkDeployment() {
        window.open("http://localhost:5175/", "_blank");
      }
    </script>
  </body>
</html>
