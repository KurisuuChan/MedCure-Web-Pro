<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Fix Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <h1>üîß Pricing Diagnostic & Fix Tool</h1>
    
    <div class="section">
        <h2>üîç Quick Diagnostics</h2>
        <button onclick="runFullDiagnostic()">Run Full Diagnostic</button>
        <button onclick="checkProducts()">Check Product Prices</button>
        <button onclick="checkTransactions()">Check Transactions</button>
        <pre id="diagnostic-output">Click a button to start...</pre>
    </div>
    
    <div class="grid">
        <div class="section">
            <h2>üìä Recent Transactions</h2>
            <div id="transactions-output">Loading...</div>
        </div>
        
        <div class="section">
            <h2>üíä Product Prices</h2>
            <div id="products-output">Loading...</div>
        </div>
    </div>
    
    <div class="section">
        <h2>üîß Quick Fixes</h2>
        <button onclick="fixZeroPrices()">Fix Zero-Price Products</button>
        <button onclick="recalculateTransaction()">Recalculate Last Transaction</button>
        <div id="fix-output"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ehooclfzvcjwlplezlxz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVob29jbGZ6dmNqd2xwbGV6bHh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk5Mzk3MjUsImV4cCI6MjA0NTUxNTcyNX0.DGPdOjv2u4Gw5BlmyL8PbNLBd8W8LMK8vBR_Yb1sfeM';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        function log(message, type = 'info') {
            const output = document.getElementById('diagnostic-output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        async function runFullDiagnostic() {
            const output = document.getElementById('diagnostic-output');
            output.innerHTML = 'üîç Starting full diagnostic...\n';
            
            await checkProducts();
            await checkTransactions();
            
            log('‚úÖ Full diagnostic complete', 'success');
        }
        
        async function checkProducts() {
            try {
                log('üîç Checking product prices...');
                
                const { data: products, error } = await supabase
                    .from('products')
                    .select('id, name, price_per_piece, unit_type, pieces_per_sheet, sheets_per_box')
                    .limit(20);
                
                if (error) throw error;
                
                const zeroPrice = products.filter(p => !p.price_per_piece || p.price_per_piece === 0);
                const validPrice = products.filter(p => p.price_per_piece > 0);
                
                log(`üìä Found ${products.length} products total`);
                log(`‚úÖ ${validPrice.length} products with valid prices`);
                log(`‚ùå ${zeroPrice.length} products with zero/null prices`, zeroPrice.length > 0 ? 'error' : 'success');
                
                if (zeroPrice.length > 0) {
                    log('Zero-price products:', 'warning');
                    zeroPrice.forEach(p => log(`  - ${p.name}: ‚Ç±${p.price_per_piece || 0}`, 'warning'));
                }
                
                // Update products display
                const productsOutput = document.getElementById('products-output');
                productsOutput.innerHTML = `
                    <div class="success">Valid Prices: ${validPrice.length}</div>
                    <div class="${zeroPrice.length > 0 ? 'error' : 'success'}">Zero Prices: ${zeroPrice.length}</div>
                    <div>Total Products: ${products.length}</div>
                `;
                
            } catch (error) {
                log(`‚ùå Error checking products: ${error.message}`, 'error');
            }
        }
        
        async function checkTransactions() {
            try {
                log('üîç Checking recent transactions...');
                
                const { data: transactions, error } = await supabase
                    .from('sales')
                    .select(`
                        *,
                        sale_items (
                            *,
                            products (name, price_per_piece)
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const zeroTotal = transactions.filter(t => !t.total_amount || t.total_amount === 0);
                const validTotal = transactions.filter(t => t.total_amount > 0);
                
                log(`üìä Found ${transactions.length} recent transactions`);
                log(`‚úÖ ${validTotal.length} transactions with valid totals`);
                log(`‚ùå ${zeroTotal.length} transactions with zero totals`, zeroTotal.length > 0 ? 'error' : 'success');
                
                // Check individual items
                let itemsWithZeroPrices = 0;
                transactions.forEach(trans => {
                    trans.sale_items?.forEach(item => {
                        if (!item.unit_price || item.unit_price === 0 || !item.total_price || item.total_price === 0) {
                            itemsWithZeroPrices++;
                        }
                    });
                });
                
                log(`üì¶ Items with zero prices: ${itemsWithZeroPrices}`, itemsWithZeroPrices > 0 ? 'error' : 'success');
                
                // Update transactions display
                const transOutput = document.getElementById('transactions-output');
                transOutput.innerHTML = `
                    <div class="success">Valid Totals: ${validTotal.length}</div>
                    <div class="${zeroTotal.length > 0 ? 'error' : 'success'}">Zero Totals: ${zeroTotal.length}</div>
                    <div class="${itemsWithZeroPrices > 0 ? 'error' : 'success'}">Zero-Price Items: ${itemsWithZeroPrices}</div>
                    <div>Total Transactions: ${transactions.length}</div>
                `;
                
            } catch (error) {
                log(`‚ùå Error checking transactions: ${error.message}`, 'error');
            }
        }
        
        async function fixZeroPrices() {
            try {
                log('üîß Attempting to fix zero-price products...');
                
                // Get products with zero prices
                const { data: zeroProducts, error: fetchError } = await supabase
                    .from('products')
                    .select('id, name, price_per_piece')
                    .or('price_per_piece.is.null,price_per_piece.eq.0');
                
                if (fetchError) throw fetchError;
                
                if (zeroProducts.length === 0) {
                    log('‚úÖ No zero-price products found', 'success');
                    return;
                }
                
                log(`Found ${zeroProducts.length} products to fix`);
                
                // Set a default price (you can modify this logic)
                const updates = zeroProducts.map(product => ({
                    id: product.id,
                    price_per_piece: 10.00 // Default price
                }));
                
                // Update products (this is a demo - you might want to be more selective)
                log('‚ö†Ô∏è Would update products with default ‚Ç±10.00 price', 'warning');
                log('Manual review recommended before applying fixes', 'warning');
                
                document.getElementById('fix-output').innerHTML = `
                    <div class="warning">
                        Found ${zeroProducts.length} products with zero prices.<br>
                        Consider setting proper prices manually in your database.
                    </div>
                `;
                
            } catch (error) {
                log(`‚ùå Error fixing prices: ${error.message}`, 'error');
            }
        }
        
        async function recalculateTransaction() {
            log('üîß This would recalculate the last transaction', 'warning');
            log('Implementation depends on your business logic', 'warning');
        }
        
        // Auto-run basic checks when page loads
        window.onload = () => {
            checkProducts();
            checkTransactions();
        };
    </script>
</body>
</html>
