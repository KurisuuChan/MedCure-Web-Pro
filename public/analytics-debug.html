<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics Debug Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .metric {
        padding: 15px;
        margin: 10px 0;
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        border-radius: 4px;
      }
      .error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .success {
        border-left-color: #28a745;
        background: #d4edda;
      }
      .loading {
        text-align: center;
        padding: 40px;
      }
      pre {
        background: #f1f3f4;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Analytics Debug Test</h1>
      <div id="status" class="loading">
        üîÑ Testing Analytics Data Loading...
      </div>
      <div id="results"></div>
    </div>

    <script type="module">
      async function testAnalytics() {
        const statusDiv = document.getElementById("status");
        const resultsDiv = document.getElementById("results");

        try {
          statusDiv.innerHTML = "üîÑ Loading Supabase configuration...";

          // Import Supabase client (mimicking the app structure)
          const supabaseUrl = "https://jmnxhudqdjhxxowgxdlk.supabase.co";
          const supabaseKey =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpteGh1ZHFkamh4eG93Z3hkbGsiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTczNTkwMDY2OSwiZXhwIjoyMDUxNDc2NjY5fQ.LOD1lDC8_UqYw7xTMF3Nwlz2F6U-X7oeOFYrJOGMKz0";

          statusDiv.innerHTML = "üîÑ Fetching products from database...";

          // Direct database call
          const response = await fetch(
            `${supabaseUrl}/rest/v1/products?select=*&order=name`,
            {
              headers: {
                apikey: supabaseKey,
                Authorization: `Bearer ${supabaseKey}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const products = await response.json();

          statusDiv.innerHTML = "‚úÖ Data loaded successfully!";
          statusDiv.className = "metric success";

          // Calculate analytics
          const activeProducts = products.filter((p) => !p.is_archived);
          const today = new Date();

          const analytics = {
            totalProducts: activeProducts.length,
            archivedProducts: products.filter((p) => p.is_archived).length,
            lowStockProducts: activeProducts.filter(
              (p) =>
                p.stock_in_pieces > 0 &&
                p.stock_in_pieces <= (p.reorder_level || 10)
            ).length,
            outOfStockProducts: activeProducts.filter(
              (p) => p.stock_in_pieces <= 0
            ).length,
            expiringProducts: activeProducts.filter((p) => {
              if (!p.expiry_date) return false;
              const expiry = new Date(p.expiry_date);
              const daysUntilExpiry = Math.ceil(
                (expiry - today) / (1000 * 60 * 60 * 24)
              );
              return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
            }).length,
            expiredProducts: activeProducts.filter((p) => {
              if (!p.expiry_date) return false;
              const expiry = new Date(p.expiry_date);
              return expiry < today;
            }).length,
            totalValue: activeProducts.reduce(
              (sum, p) =>
                sum + (p.price_per_piece || 0) * (p.stock_in_pieces || 0),
              0
            ),
          };

          // Category distribution
          const categoryStats = activeProducts.reduce((acc, p) => {
            const cat = p.category || "Uncategorized";
            acc[cat] = (acc[cat] || 0) + 1;
            return acc;
          }, {});

          resultsDiv.innerHTML = `
                    <div class="metric">
                        <h3>üìä Products Overview</h3>
                        <p><strong>Total Products:</strong> ${
                          analytics.totalProducts
                        }</p>
                        <p><strong>Archived Products:</strong> ${
                          analytics.archivedProducts
                        }</p>
                        <p><strong>Raw Data Count:</strong> ${
                          products.length
                        }</p>
                    </div>
                    
                    <div class="metric">
                        <h3>üìà Stock Analytics</h3>
                        <p><strong>Low Stock Products:</strong> ${
                          analytics.lowStockProducts
                        }</p>
                        <p><strong>Out of Stock Products:</strong> ${
                          analytics.outOfStockProducts
                        }</p>
                        <p><strong>Total Inventory Value:</strong> ‚Ç±${analytics.totalValue.toLocaleString()}</p>
                    </div>
                    
                    <div class="metric">
                        <h3>‚è∞ Expiry Analytics</h3>
                        <p><strong>Expiring Soon (30 days):</strong> ${
                          analytics.expiringProducts
                        }</p>
                        <p><strong>Already Expired:</strong> ${
                          analytics.expiredProducts
                        }</p>
                    </div>
                    
                    <div class="metric">
                        <h3>üè∑Ô∏è Category Distribution</h3>
                        ${Object.entries(categoryStats)
                          .map(
                            ([cat, count]) =>
                              `<p><strong>${cat}:</strong> ${count} products</p>`
                          )
                          .join("")}
                    </div>
                    
                    <div class="metric">
                        <h3>üîç Sample Products</h3>
                        <pre>${JSON.stringify(
                          activeProducts.slice(0, 3).map((p) => ({
                            id: p.id,
                            name: p.name,
                            category: p.category,
                            stock: p.stock_in_pieces,
                            price: p.price_per_piece,
                            reorder_level: p.reorder_level,
                            expiry: p.expiry_date,
                            is_archived: p.is_archived,
                          })),
                          null,
                          2
                        )}</pre>
                    </div>
                `;
        } catch (error) {
          statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
          statusDiv.className = "metric error";

          resultsDiv.innerHTML = `
                    <div class="metric error">
                        <h3>üö® Error Details</h3>
                        <pre>${error.stack || error.message}</pre>
                    </div>
                `;
        }
      }

      // Run the test
      testAnalytics();
    </script>
  </body>
</html>
